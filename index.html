<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="style/earth.ico" type="image/x-icon">

    <title>COVID19</title>
    <style>
        #play-button {
            position: absolute;
            top: 200px;
            left: 50px;
            background: #f08080;
            padding-right: 26px;
            border-radius: 3px;
            border: none;
            color: white;
            margin: 0;
            padding: 0 12px;
            width: 60px;
            cursor: pointer;
            height: 30px;
            z-index: 999;
        }

        #play-button:hover {
            background-color: #696969;
        }

        .ticks {
            font-size: 10px;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #dcdcdc;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }

        #explain {
            position: absolute;
            top: 1300px;
        }

        #explain2 {
            position: absolute;
            top: 1900px;
            left: 700px;
            width: 750px;
        }

        #explain3 {
            position: absolute;
            top: 2500px;
            left: 700px;
        }

        .selected {
            fill: greenyellow;
        }

        #tooltip {
            z-index: 10;
            /* background-color: #000; */
        }

        .dropDownList {
            margin-top: 40px;
            margin-left: 25em;
            width: auto;
        }

        #worldline {
            position: absolute;
            top: 330px;
            left: 750px;
            font-size: 25px;
        }

        #sliderSvg {
            position: absolute;
            left: 250px;
        }

        #first {
            position: absolute;
            top: 700px;
            left: 150px;
        }

        #map {
            position: absolute;
            top: 180px;
        }

        /* #selectors2{
        position: absolute;
        right:400px;
    } */

        .focus circle {
            fill: #F1F3F3;
            stroke: #6F257F;
            stroke-width: 5px;
        }

        .hover-line {
            stroke: #6F257F;
            stroke-width: 2px;
            stroke-dasharray: 3, 3;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px;
        }

        html {
            font-family: 'Arial', sans-serif;
        }

        .header {
            margin-top: 60px;
            margin-left: 60px;
            text-align: left;
        }

        #barchart {
            position: absolute;
            top: 730px;
            left: 770px;
        }

        input {
            margin-right: 10px;
        }

        .form-check-label {
            font-size: 0.8em;
            margin-right: 20px;
        }


        #lineChart {
            position: absolute;
            top: 1900px;
            left: 180px;
            z-index: 10;
        }
    </style>

    <!-- Bootstrap core CSS -->
    <link href="style/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <!-- <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> -->
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
        type='text/css'>
    <link
        href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
        rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link href="style/clean-blog.min.css" rel="stylesheet">

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">COVID19</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <!-- link to different place in this page -->
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#selectors">spread trend</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#lineChart">Top 10 analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link js-scroll-trigger" href="#explain3">Author Information</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="masthead" style="background-image: url('img/covid1.jpg')">
        <div class="overlay"></div>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                    <div class="site-heading">
                        <h1>The Spread of COVID19</h1>
                        <span class="subheading">A data analysis of the spread of viruses around the world from
                            2020/01/22 to 2020/06/15</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="selectors"></div>
    <div id="sliderSvg">
        <button id="play-button">Play</button>
    </div>
    <div id="first" width="700" height="450">
        <svg id="map" width="700" height="450"></svg>
        <svg id="worldline" width="700" height="350" viewBox="0 0 1000 650"></svg>
        <svg id="barchart" width="700" height="450" viewBox="0 0 1000 800"></svg>
    </div>

    <div class="container" id="explain">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="post-preview">
                    <h2 class="post-title">
                        How COVID-19 spread around the world?
                    </h2>
                    <h6 class="post-subtitle">
                        Cumulative confirmed cases; daily increase confirm cases
                    </h6>
                    <p class="post-meta">
                        There are two ways to render the map, which can be selected through the drop-down menu.
                        One is the cumulative confirmed cases, the other one is daily increase confirmed cases.
                        Click Play button to play or drag the timeline to view the data at the exact time.
                        The line chart on the right side of the map represents global data, you can hover to find
                        certain time world data. Use mouse hover different
                        countries, you can see the current country's confirmed cases, increase, death, and recover at
                        the certain date.
                    </p>

                    <p class="post-meta">
                        It can be seen from the data that China is the first country to outbreak. Before the beginning
                        of February, the
                        virus has been concentrated in China. The virus began to spread globally in the middle of
                        February.
                        Most countries have confirmed cases with varying degrees of spread. The America and Europe are
                        the most severe except for China.
                        In the middle of March, the epidemic situation in countries around Italy was serious. While the
                        US has reached 1568k
                        by the latest data(06/15), far exceeding other countries.
                    </p>

                    <p class="post-meta">
                        For increase map you can find until latest data, America still didnot control the virus, but the
                        first breakout country which is China
                        does not have do much increase, which means the COVID19 has been brought under control in China
                        and already reached the inflection point.
                    </p>
                </div>
            </div>
        </div>
        <hr>
    </div>

    <div id="lineChart">
        <div id="selectors2"></div>
        <!-- Create a div where the graph will take place -->
        <div id="chart"></div>
    </div>

    <div class="container" id="explain2">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="post-preview">
                    <h2 class="post-title">
                        The spread of trend for Top9 countries & China
                    </h2>
                    <h6 class="post-subtitle">
                        Linear function & Log function for confirmed cases
                    </h6>
                    <p class="post-meta">
                        There are two ways to render the confirmed cases, which can be selected through the drop-down
                        menu.
                        One is the linear function, the other one is log function.
                        Hover the mouse on lines can see the certain countries data for date. The first country seen by
                        hovering is the worst.
                    </p>

                    <p class="post-meta">
                        Why use two ways to render, the confirmed cases in US is much larger than other countries, the
                        data changes in other countries are ignored, it
                        is difficult to see the difference in slope. Using the log function is more easy to see the
                        difference in slope.
                    </p>

                    <p class="post-meta">
                        For increase map you can find until latest data, America still didnot control the virus, but the
                        first breakout country which is China
                        does not have do much increase, which means the COVID19 has been brought under control in China
                        and already reached the inflection point.
                    </p>
                </div>
            </div>
        </div>
        <hr>
    </div>



    <!-- Footer -->
    <footer>
        <div class="container" id="explain3">
            <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                    <div class="post-preview">
                        <p class="post-meta">
                            Qiutong Jin 29822335 - FIT5147 final Project
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- <script src="style/bootstrap.bundle.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Custom scripts for this template -->
    <!-- <script src="js/clean-blog.min.js"></script> -->
    <script>

        map();
        // wordLine();
        lineCharTop10();


        ////////////////////map + date + drop down list////////////////////////////
        function map() {
            var svg = d3.select("#map"),
                width = +svg.attr("width"),
                height = +svg.attr("height");

            var dataset;



            var margin = { top: 50, right: 50, bottom: 0, left: 50 },
                width = 960 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;
            var sliderSvg = d3.select("#sliderSvg")
                .append("svg")
                .attr("width", 1000)
                .attr("height", 100);
            var slider = sliderSvg.append("g")
                .attr("class", "slider")
                .attr("transform", "translate(" + margin.left + "," + height / 10 + ")");



            ////////////////// for drop down list ////////////////////
            var fields = ["cumulative confirmed cases", "daily increase confirm cases"]
            var dropDownList = d3.select('#selectors').append("select")
                .attr("class", "dropDownList")
                // .attr("margin-left", margin.left)
                .attr("transform", "translate(" + 100 + "," + 100 + ")");
            // .on("change",dropDownChange);
            for (var i = 0; i < fields.length; i++) {
                var opt = dropDownList.append("option")
                    .attr("value", fields[i])
                    .text(fields[i]);
            }

            dropDownList.on("change", function () {
                console.log("choose: " + $("#selectors").find(".dropDownList").val())
                // d3.select("#worldline").select("#mark").remove();
                //     d3.select("#worldline").select("#markText").remove();
                //     d3.select("#worldline").select("#wordlineX").remove();
                //     d3.select("#worldline").select("#wordlineY").remove();
                drawMap(dataset, $("#selectors").find(".dropDownList").val());
            });



            ///////// for play button and slider /////////////////
            var formatDateIntoMonth = d3.timeFormat("%d-%m");
            var formatAsMonth = d3.timeFormat("%B");
            var formatDate = d3.timeFormat("%b %d, %Y");
            var startDate = new Date("2020-01-22"), endDate = new Date("2020-06-15");


            //set slider
            var moving = false;
            var currentValue = 0;
            var targetValue = width;
            var playButton = d3.select("#play-button");
            // //设置给定时间范畴
            var x = d3.scaleTime()
                .domain([startDate, endDate])
                .range([0, targetValue])
                .clamp(true);



            //set slider
            slider.append("line")
                .attr("class", "track")
                .attr("x1", x.range()[0])
                .attr("x2", x.range()[1])
                .select(function () {
                    return this.parentNode.appendChild(this.cloneNode(true));
                }).attr("class", "track-inset")
                .select(function () {
                    return this.parentNode.appendChild(this.cloneNode(true));
                }).attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function () { slider.interrupt(); })
                    .on("start drag", function () {
                        currentValue = d3.event.x;
                        update(x.invert(currentValue));
                    })
                );

            //set slider x 轴文字
            slider.insert("g", ".track-overlay")
                .attr("class", "ticks")
                .attr("transform", "translate(0," + 18 + ")")
                .selectAll("text")
                .data(x.ticks(10))
                .enter()
                .append("text")
                .attr("x", x)
                .attr("y", 10)
                .attr("text-anchor", "middle")
                .text(function (d) { return formatAsMonth(d) });


            //定义上方滑块
            var handle = slider.insert("circle", ".track-overlay")
                .attr("class", "handle")
                .attr("r", 9);

            //定义上方date label
            var label = slider.append("text")
                .attr("class", "label")
                .attr("text-anchor", "middle")
                .text(formatDate(startDate))
                .attr("transform", "translate(0," + (-25) + ")")

            function step() {
                update(x.invert(currentValue));
                currentValue = currentValue + (targetValue / 151);
                if (currentValue > targetValue) {
                    moving = false;
                    currentValue = 0;
                    clearInterval(timer);
                    //timer = 0;
                    playButton.text("Play");
                    console.log("Slider moving: " + moving);
                }
            }


            function convertDate(date) {
                // var date = new Date("Fri Jan 31 2014 00:00:00 GMT-0800 (Pacific Standard Time)");
                var year = date.getFullYear();
                var month = date.getMonth() + 1 //getMonth is zero based;
                var day = date.getDate();
                if (month < 10) {
                    month = "0" + month
                }
                if (day < 10) {
                    day = "0" + day
                }
                var formatted = year + "-" + month + "-" + day;
                return formatted;
            }

            function update(h) {
                // console.log("H: " +h);
                var str = convertDate(h);
                console.log("Date: " + str);
                //更新滑块 label位置
                handle.attr("cx", x(h));
                label.attr("x", x(h))
                    .text(formatDate(h));

                //filter data set& redraw plot
                // console.log("try dataset: "+ dataset)
                var newData = dataset.filter(function (d) {
                    // if(d.date == "2020-02-01"){console.log("date.dataset: "+ d.date)}
                    return d.date == str
                })
                // console.log("NewData: " + newData);
                // console.log("Update Choose: " + choose);
                // d3.select("#worldline").select("#mark").remove();
                //     d3.select("#worldline").select("#markText").remove();
                //     d3.select("#worldline").select("#wordlineX").remove();
                //     d3.select("#worldline").select("#wordlineY").remove();
                drawMap(newData, $("#selectors").find(".dropDownList").val());
            }



            //add to test
            function filterData(d) {
                // console.log("D.date-TEST: " + d.date);
                d.code = d.code;
                d.date = d.date;
                // if("#selectors").find("")
                d.confirmed = d.confirmed;
                // console.log("prepare-date: " + d.date);
                return d;
            }






            d3.csv("confirmedIncreaseDeathRecover.csv", function (mapdata) {
                dataset = mapdata;
                // console.log("0: " +dataset[0].date)
                // console.log($("#selectors").find(".dropDownList").val())
                drawMap(dataset, $("#selectors").find(".dropDownList").val())

                // console.log(choose)
                playButton.on("click", function () {
                    console.log("Play-TEST")
                    var button = d3.select(this);
                    if (button.text() == "Pause") {
                        moving = false;
                        clearInterval(timer);
                        //timer = 0;
                        button.text("Play");
                    } else {
                        moving = true;
                        timer = setInterval(step, 100);
                        button.text("Pause");
                    }
                    console.log("Slider moving " + moving);
                })



            })




            ////////////////// for map ////////////////////
            var path = d3.geoPath().projection(projection);
            var projection = d3.geoMercator()
                .scale(80).center([0, 20]).translate([width / 2, height / 2]);

            // var data = d3.map();
            var colorScale = d3.scaleThreshold().domain([100, 1000, 5000, 10000, 50000, 100000,500000, 1000000, 3000000 ]).range(["rgb(247,251,255)",  "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)", "rgb(33,113,181)", "rgb(8,81,156)", "rgb(8,48,107)", "rgb(3,19,43)"]);

            //legend
            var g = svg.append("g")
                .attr("class", "legendThreshold")
                .attr("transform", "translate(40,150)");
            g.append("text")
                .attr("class", "caption")
                .attr("x", 0)
                .attr("y", -6)
                .text("Confirmed Cases");




            ////////////////// for map labels ////////////////////
            var labels = ['0-100', '100-1000', '1k-5k', '5k-10k', '10k-50k', '50k-100k', '100k-500k', '50k-1m', '>1m'];
            var legend = d3.legendColor()  // call back function
                .labels(function (d) { return labels[d.i]; })
                .shapePadding(4)
                .scale(colorScale);
            svg.select(".legendThreshold")
                .call(legend);


            /////////////////////////// bar chart //////////////////////////////
            // drawBar("ALB", "2020-03-29")

            function drawBar(code, date) {

                var margin = { top: 20, right: 20, bottom: 30, left: 40 },
                    width = 700 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;
                // set the ranges
                var x = d3.scaleBand()
                    .range([0, width])
                    .padding(0.1);
                var y = d3.scaleLinear()
                    .range([height, 0]);

                // append the svg object to the body of the page
                // append a 'group' element to 'svg'
                // moves the 'group' element to the top left margin
                var bar = d3.select("#barchart")
                    // .attr("width", width + margin.left + margin.right)
                    // .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");


                // get the data
                d3.csv("confirmedIncreaseDeathRecover.csv", function (error, data) {
                    if (error) throw error;
                    //filter data
                    var onedata = data.filter(function (d) {
                        // if(d.date == "2020-02-01"){console.log("date.dataset: "+ d.date)}
                        return (d.date == date && d.code == code)
                    })
                    if ((typeof (onedata[0].increase) === 'undefined')) {
                        onedata[0].increase = 0;
                    }
                    if (parseInt(onedata[0].increase) < 0) {
                        onedata[0].increase = 0
                    }
                    // console.log("onedata: "+ onedata[0].confirmed)
                    // format the data
                    var result = [{ category: "confirmed", number: parseInt(onedata[0].confirmed) },
                    { category: "increase", number: parseInt(onedata[0].increase) },
                    { category: "death", number: parseInt(onedata[0].death) },
                    { category: "recover", number: parseInt(onedata[0].recover) }]
                    // onedata.forEach(function (d) {
                    //     {category: "confirmed", "number":parseInt(d.confirmed)}

                    //     result.category = ["confirmed", "increase", "death", "recover"];
                    //     result.number = [parseInt(d.confirmed), parseInt(d.increase), parseInt(d.death), parseInt(d.recover)];
                    // });
                    console.log("this: " + result[0].number)

                    var maxY = 0;
                    for (var i = 0; i < 4; i++) {
                        if (maxY < result[i].number) {
                            console.log(result[i].number);
                            maxY = result[i].number;
                        }
                    }

                    var color = d3.scaleOrdinal(d3.schemeCategory20);
                    x.domain(["confirmed", "increase", "death", "recover"]);
                    y.domain([0, maxY]);

                    // append the rectangles for the bar chart
                    bar.selectAll(".bar")
                        .data(result)
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", function (d) { return x(d.category); })
                        .attr("fill", function (d) {
                            // console.log(d.category)
                            return color(d.category);
                        })
                        .attr("width", x.bandwidth())
                        .attr("y", function (d) {
                            console.log(d.number)
                            return y(d.number);
                        })
                        .attr("height", function (d) {
                            // console.log(d)
                            return height - y(d.number);
                        })

                    // add the x Axis
                    bar.append("g")
                        .style("font", "20px times")
                        .attr("class", "barX")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                    //title
                    bar.append("text")
                        .attr("class", "title")
                        .attr("x", (width / 2 + 10))
                        .attr("y", 0 - (margin.top / 2) + 10)
                        .attr("text-anchor", "middle")
                        .style("font-size", "20px")
                        .style("text-decoration", "underline")
                        .text(code + " in " + date);

                    // add the y Axis
                    bar.append("g")
                        .attr("class", "barY")
                        .style("font", "20px times")
                        .call(d3.axisLeft(y));

                    bar.selectAll(".text")
                        .data(result)
                        .enter()
                        .append("text")
                        .attr("class", "label")
                        .attr("x", (function (d) { return x(d.category) + x.bandwidth() / 2 }))
                        .attr("y", function (d) { return y(d.number) - 20; })
                        .attr("dy", ".75em")
                        .text(function (d) { return d.number; });

                });
            }







            function drawMap(currentData, choose) {
                var mapPath = "style/world-110m.geojson";
                d3.json(mapPath, function (error, topo) {
                    var confirmedCasesById = {};
                    currentData.forEach(function (thisD) {
                        // console.log("id: " + thisD.code + " con: " + thisD.confirmed)
                        // console.log("choose: " + choose);
                        if (choose == "cumulative confirmed cases") {
                            confirmedCasesById[thisD.code] = + thisD.confirmed;
                        } else if (choose == "daily increase confirm cases") {
                            confirmedCasesById[thisD.code] = + thisD.increase;
                        }

                        // data.set(thisD.code,+thisD.confirmed);
                        // console.log("thisData: "+data.get(thisD.id))
                    });

                    topo.features.forEach(function (d) {
                        d.confirmed = confirmedCasesById[d.id]
                    });
                    console.log("TEST: " + currentData[0].date);
                    // console.log("TEST: " + d.id);
                    
                    // if have remove that
                    d3.select("#worldline").select("#mark").remove();
                    d3.select("#worldline").select("#markText").remove();
                    d3.select("#worldline").select("#wordlineX").remove();
                    d3.select("#worldline").select("#wordlineY").remove();
                    wordLine(currentData[0].date);


                    //mouse
                    let mouseOver = function (d) {
                        d3.selectAll(".countries")
                        // .style("opacity", .5);
                        d3.select(this)
                            .classed("selected", true)
                            // .style("opacity", 1)
                            .style("stroke", "black")

                        // console.log("TEST2: " + d.id);
                        d3.select("#barchart").selectAll(".bar").remove()
                        d3.select("#barchart").selectAll(".barX").remove()
                        d3.select("#barchart").selectAll(".barY").remove()
                        d3.select("#barchart").selectAll(".label").remove()
                        d3.select("#barchart").selectAll(".title").remove()
                        drawBar(d.id, currentData[0].date)

                    }

                    let mouseLeave = function (d) {
                        d3.selectAll(".countries")
                        // .style("opacity", .8)
                        d3.select(this)
                            .classed("selected", false)
                            .style("stroke", "transparent")
                    }

                    svg.append("g")
                        .attr("class", "countries")
                        .selectAll("path")
                        .data(topo.features)
                        .enter().append("path")
                        .attr("d", d3.geoPath().projection(projection))  // 目前出地图轮廓
                        .style("stroke", "transparent")
                        .style("opacity", 1)
                        .on("mouseover", mouseOver)
                        .on("mouseleave", mouseLeave)
                        .attr("fill", function (thisD) {
                            //     console.log("confirm: "+thisD.id)
                            // thisD.total = data.get(thisD.id) || 0;
                            // console.log(thisD.total)
                            // return colorScale(thisD.total);
                            // console.log(confirmedCasesById[thisD.id]);
                            return colorScale(confirmedCasesById[thisD.id] || 0);
                        });

                    svg.exit().remove();

                });

            }
        }







        //////////////////////world line/////////////////////////

        function wordLine(currentDate) {
            var formatDateIntoMonth = d3.timeFormat("%d-%m");
            

            // set the dimensions and margins of the graph
            var margin = { top: 10, right: 30, bottom: 30, left: 60 },
                width = 700 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var wordline = d3.select("#worldline")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            


            //Read the data
            d3.csv("sumdata.csv", function (d) {
                return { date: d3.timeParse("%Y-%m-%d")(d.date), confirmed: d.confirmed }
            }, function (data) {

                // console.log(d3.timeParse("%Y-%m-%d")("2020-01-22"))

                // Add X axis --> it is a date format
                // 映射方程
                var x = d3.scaleTime()
                    .domain(d3.extent(data, function (d) {
                        return d.date;
                    }))
                    .range([0, width - 60]);

                wordline.append("g").attr("id","wordlineX")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // Add Y axis
                var y = d3.scaleLinear()
                    .domain([0, d3.max(data, function (d) { return +d.confirmed; })])
                    .range([height, 0]);
                wordline.append("g").attr("id","wordlineY")
                    .call(d3.axisLeft(y));

                // find the closest x-axis index of the mouse
                var bisect = d3.bisector(function (d) { return d.date; }).left;

                function convertDate(date) {
                    // var date = new Date("Fri Jan 31 2014 00:00:00 GMT-0800 (Pacific Standard Time)");
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1 //getMonth is zero based;
                    var day = date.getDate();
                    if (month < 10) {
                        month = "0" + month
                    }
                    if (day < 10) {
                        day = "0" + day
                    }
                    var formatted = year + "-" + month + "-" + day;
                    return formatted;
                }

            


                //create the circle
                var focus = wordline
                    .append('g')
                    .append('circle').attr("id","mark")
                    .style("fill", "steelblue")
                    .attr("stroke", "black")
                    .attr('r', 8)
                    .style("opacity", 0);

                //create the circle text
                var focusText = wordline
                    .append('g')
                    .append('text').attr("id","markText")
                    .style("opacity", 0)
                    .attr("text-anchor", "left")
                    .attr("alignment-baseline", "middle")


            

                // Add the line
                wordline.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 5)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) })
                        .y(function (d) { return y(d.confirmed) })
                    )

                var selected
                data.forEach(function (d) {
                    //  console.log("1: " + convertDate(d.date));
                    //  console.log("2: " + currentDate);
                    if (convertDate(d.date) === currentDate) {
                        console.log("d" + d)
                        selected = d
                    }
                })
                console.log("currentDate -> : " + currentDate);
                console.log("selected -> : " + selected);

                if ((typeof (currentDate) !== 'undefined')) {
                    // console.log("here")
                    focus.style("opacity", 1).attr("transform", "translate(" + x(selected.date) + "," + y(selected.confirmed) + ")")
                    focusText
                        .html("-->" + selected.confirmed)
                        .style("opacity", 1).attr("transform", "translate(" + x(selected.date) + "," + y(selected.confirmed) + ")")
                }

                //add the focus effect
                wordline.append('rect')
                    .style("fill", "none")
                    .style("pointer-events", "all")
                    .attr('width', width)
                    .attr('height', height)
                    .on('mouseover', mouseover)
                    .on('mousemove', mousemove)
                    .on('mouseout', mouseout);


                //mouse over and move effect
                function mouseover() {
                    focus.style("opacity", 1)
                    focusText.style("opacity", 1)
                }

                function mousemove() {
                    // recover coordinate we need
                    var x0 = x.invert(d3.mouse(this)[0]);
                    var i = bisect(data, x0, 1);
                    selectedData = data[i]
                    // console.log("Sel-> " + selectedData.date)
                    focus.attr("transform", `translate(${x(selectedData.date)},${y(selectedData.confirmed)})`)
                    focusText
                        .html("-->" + selectedData.confirmed)
                        .attr("transform", `translate(${x(selectedData.date)},${y(selectedData.confirmed)})`)
                    // console.log("x-data: " + x(selectedData.x))
                }
                function mouseout() {
                    focus.style("opacity", 0)
                    focusText.style("opacity", 0)
                }
            })


        }





        /////////////////////line chart for top 10///////////////////////////////
        function lineCharTop10() {
            var glines
            var mouseG
            var tooltip

            /////////////////////// for drop down list ////////////////////////
            var dataset;
            var fields = ["Linear", "Logarithmic"]
            var dropDownList = d3.select('#selectors2').append("select")
                .attr("class", "dropDownList")
                // .attr("margin-left", margin.left)
                .attr("transform", "translate(" + 100 + "," + 100 + ")");
            // .on("change",dropDownChange);
            for (var i = 0; i < fields.length; i++) {
                var opt = dropDownList.append("option")
                    .attr("value", fields[i])
                    .text(fields[i]);
            }



            /////////////////////////// line chart /////////////////////////////////    

            // set the dimensions and margins of the graph
            var margin = { top: 10, right: 30, bottom: 30, left: 60 },
                width = 660 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");


            function prepare(d) {
                return { date: d3.timeParse("%Y-%m-%d")(d.date), confirmed: d.confirmed, code: d.code }
            }

            //Read the data
            d3.csv("top10all.csv", prepare, function (data) {
                dataset = data;
                drawLine(data);
            })

            function drawLine(data) {
                // group the data: I want to draw one line per group
                var sumstat = d3.nest()
                    .key(function (d) {
                        // console.log("All: "+d.code);
                        return d.code;
                    })
                    .entries(data);

                // Add X axis --> it is a date format
                var x = d3.scaleTime()
                    .domain(d3.extent(data, function (d) { return d.date; }))
                    .range([0, width]);

                svg.append("g")
                    .attr("id", "x-axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                var y
                if ($("#selectors2").find(".dropDownList").val() == "Linear") {
                    console.log("TEST HERE Linear")
                    y = d3.scaleLinear()
                        .domain([1, d3.max(data, function (d) { return +d.confirmed; })])
                        .range([height, 0]);
                } else if ($("#selectors2").find(".dropDownList").val() == "Logarithmic") {
                    console.log("TEST HERE Log")
                    var y = d3.scaleLog()
                        .domain([1, d3.max(data, function (d) { return +d.confirmed; })])
                        .range([height, 0]).base(10);
                }

                svg.append("g")
                    .attr("id", "y-axis")
                    .call(d3.axisLeft(y));

                // color palette
                var res = sumstat.map(function (d) {
                    return d.key
                }) // list of group names

                var color = d3.scaleOrdinal()
                    .domain(res)
                    .range(['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf', '#999999', '#7FFFD4'])

                // console.log("sumstat: " + sumstat);
                // Draw the line
                svg.selectAll("#lines")
                    .data(sumstat).enter()
                    .append("path")
                    .attr("id", "lines")
                    .attr("fill", "none")
                    .attr("stroke", function (d) {
                        // console.log("Test: "+ d.key)
                        return color(d.key)
                    })
                    .attr("stroke-width", 1.5)
                    .attr("d", function (d) {
                        // console.log("values: " + d.key);
                        return d3.line()
                            .x(function (d) {
                                // console.log("date: " + d.date);
                                return x(d.date)
                            })
                            .y(function (d) {
                                console.log("code: " + d.code);
                                // console.log("confirmed: " + y(+d.confirmed));
                                if (d.confirmed == 0) {
                                    d.confirmed += 1
                                }
                                return y(+d.confirmed)
                            })
                            (d.values)
                    });


                tooltip = d3.select("#chart").append("div")
                    .attr('id', 'tooltip')
                    .style('position', 'absolute')
                    .style("background-color", "#fff")
                    .style('padding', 6)
                    .style('display', "none")

                mouseG = svg.append("g")
                    .attr("class", "mouse-over-effects");

                mouseG.append("path") // create vertical line to follow mouse
                    .attr("class", "mouse-line")
                    .style("stroke", "#A9A9A9")
                    .style("stroke-width", 2)
                    .style("opacity", "0");

                var lines = document.getElementById('lines');

                var mousePerLine = mouseG.selectAll('.mouse-per-line')
                    .data(sumstat)
                    .enter()
                    .append("g")
                    .attr("class", "mouse-per-line");

                mousePerLine.append("circle")
                    .attr("r", 4)
                    .style("stroke", function (d) {
                        return color(d.key)
                    })
                    .style("fill", "none")
                    .style("stroke-width", 2)
                    .style("opacity", "0");

                mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
                    .attr('width', width)
                    .attr('height', height)
                    .attr('fill', 'none')
                    .attr('pointer-events', 'all')
                    .on('mouseout', function () {
                        d3.select(".mouse-line")
                            .style("opacity", "0");
                        d3.selectAll(".mouse-per-line circle")
                            .style("opacity", "0");
                        d3.selectAll(".mouse-per-line text")
                            .style("opacity", "0");
                        d3.selectAll("#tooltip")
                            .style('display', 'none')

                    })
                    .on('mouseover', function () { // on mouse in show line, circles and text
                        d3.select(".mouse-line")
                            .style("opacity", "1");
                        d3.selectAll(".mouse-per-line circle")
                            .style("opacity", "1");
                        d3.select("#tooltip")
                            .style('display', 'block')
                    })
                    .on('mousemove', function () { // update tooltip content, line, circles and text when mouse moves
                        var mouse = d3.mouse(this)

                        d3.selectAll(".mouse-per-line")
                            .attr("transform", function (d, i) {
                                var xDate = x.invert(mouse[0]) // use 'invert' to get date corresponding to distance from mouse position relative to svg
                                var bisect = d3.bisector(function (d) { return d.date; }).left // retrieve row index of date on parsed csv
                                var idx = bisect(d.values, xDate);

                                d3.select(".mouse-line")
                                    .attr("d", function () {
                                        var data = "M" + x(d.values[idx].date) + "," + (height);
                                        data += " " + x(d.values[idx].date) + "," + 0;
                                        return data;
                                    });
                                return "translate(" + x(d.values[idx].date) + "," + y(d.values[idx].confirmed) + ")";

                            });

                        updateTooltipContent(mouse, sumstat)

                    })









                function updateTooltipContent(mouse, sumstat) {

                    sortingObj = []
                    sumstat.map(d => {
                        var xDate = x.invert(mouse[0])
                        var bisect = d3.bisector(function (d) { return d.date; }).left
                        var idx = bisect(d.values, xDate)

                        sortingObj.push({ key: d.values[idx].code, confirmed: d.values[idx].confirmed, date: d.values[idx].date })
                    })

                    sortingObj.sort(function (x, y) {
                        if ((x.confirmed - y.confirmed) > 0) {
                            return -1;
                        } else if ((x.confirmed - y.confirmed) < 0) {
                            return 1;
                        } else {
                            return 0;
                        }
                    })
                    console.log("sortingOb: " + sortingObj)
                    sortingObj.forEach(function (thisD) {
                        console.log(thisD.key)
                    })
                    var sortingArr = sortingObj.map(d => d.key)

                    var sumstat1 = sumstat.slice().sort(function (a, b) {
                        return sortingArr.indexOf(a.key) - sortingArr.indexOf(b.key)
                    })
                    var formatDateIntoMonth = d3.timeFormat("%m-%d");

                    //**** tooltip location is wrong -> 
                    tooltip.html(formatDateIntoMonth(sortingObj[0].date))
                        .style('display', 'block')
                        .style('left', (d3.event.pageX - 170) + "px")
                        .style('top', (d3.event.pageY - 1920) + "px")  // 值随着linear char top变化
                        .style('font-size', "10px")
                        .selectAll()
                        .data(sumstat1).enter() // for each vehicle category, list out name and price of premium
                        .append('div')
                        .style('color', d => {
                            return color(d.key)
                        })
                        .style('font-size', "10px")
                        .html(d => {
                            var xDate = x.invert(mouse[0])
                            var bisect = d3.bisector(function (d) { return d.date; }).left
                            var idx = bisect(d.values, xDate)
                            return d.key + ": " + d.values[idx].confirmed.toString()
                        })
                }
            }



            dropDownList.on("change", function () {
                console.log("choose: " + $("#selectors2").find(".dropDownList").val())
                svg.select("#y-axis").remove();
                svg.select("#x-axis").remove();
                svg.selectAll("path").remove();
                d3.select("#tooltip").remove();

                drawLine(dataset);
            });

        }


    </script>

</body>

</html>